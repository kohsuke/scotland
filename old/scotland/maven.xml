<project xmlns:j="jelly:core"
         xmlns:a="jelly:ant"
         xmlns:m="jelly:maven"
         xmlns:d="jelly:define"
         xmlns:sc="scotland"
         xmlns:u="jelly:util">

  <d:taglib uri="scotland">
    <!--
      @tags - which tag files?
      @tld  - tld file to generate
      @uri  - taglib uri
      @prefix - suggested prefix
    -->
    <d:tag name="generate-tld">
      <fileScanner var="tagFiles">
        <fileset dir="src/resources">
          <patternset>
            <include name="${tags}"/>
          </patternset>
        </fileset>
      </fileScanner>
      
      <echo>Generating ${tld}</echo>
      
      <j:file name="${tld}" prettyPrint="true" xmlns="dummy">
        <taglib version="2.0">
          <tlib-version>1.0</tlib-version>
          <jsp-version>2.0</jsp-version>
          <short-name>${prefix}</short-name>
          <uri>${uri}</uri>
          <info>layout control tag library for web applications</info>
          
          <j:forEach var="file" items="${tagFiles.iterator()}">
            <u:replace var="fileName" oldChar="\" newChar="/" value="${file.toString()}" />
            <tag-file>
              <j:set var="i" value="${size(file.name.substring(4))}" />
              <name>${file.name.substring(0,i)}</name>
              <path>${fileName.substring(fileName.indexOf('/META-INF'))}</path>
            </tag-file>
          </j:forEach>
        </taglib>
      </j:file>
    </d:tag>
  </d:taglib>


  <preGoal name="jar:jar">
    <attainGoal name="generate-tld" />
  </preGoal>
  
  <preGoal name="taglib:taglibdoc">
    <attainGoal name="generate-tld" />
  </preGoal>
  
  <goal name="generate-tld">
    <mkdir dir="${maven.build.dest}/META-INF" />
    <sc:generate-tld
      uri ="http://scotland.dev.java.net/"
      prefix="sc"
      tags="META-INF/tags/*.tag"
      tld ="${maven.build.dest}/META-INF/common.tld" />
    <sc:generate-tld
      uri ="http://scotland.dev.java.net/layout"
      prefix="l"
      tags="META-INF/tags/layout/*.tag"
      tld ="${maven.build.dest}/META-INF/layout.tld" />
    <sc:generate-tld
      uri ="http://scotland.dev.java.net/form"
      prefix="f"
      tags="META-INF/tags/form/*.tag"
      tld ="${maven.build.dest}/META-INF/form.tld" />
  </goal>

</project>